#!/usr/bin/env bash

# Icons (Font Awesome glyphs expected)
WIFI_ICON=""
WIRED_ICON=""
DISCONNECTED_ICON=""
LIMITED_ICON=""

get_nmcli() {
    # Find first connected device and its type
    # Output: device|type|ip|ssid|conn
    devinfo=$(nmcli -t -f DEVICE,TYPE,STATE device status 2>/dev/null | awk -F: '$3=="connected"{print $1"|"$2; exit}')
    if [ -n "$devinfo" ]; then
        dev=${devinfo%%|*}
        type=${devinfo##*|}
        ip=$(nmcli -g IP4.ADDRESS device show "$dev" 2>/dev/null | head -n1 | cut -d'/' -f1)
        ssid=""
        if [ "$type" = "wifi" ]; then
            ssid=$(nmcli -t -f NAME,DEVICE connection show --active 2>/dev/null | awk -F: -v d="$dev" '$2==d{print $1; exit}')
        fi
        conn=$(nmcli networking connectivity 2>/dev/null || echo "")
        echo "$dev|$type|$ip|$ssid|$conn"
        return 0
    fi
    return 1
}

get_iw() {
    # Check wireless interfaces reported by iw
    for w in $(iw dev 2>/dev/null | awk '/Interface/{print $2}'); do
        if iw dev "$w" link 2>/dev/null | grep -q 'Connected'; then
            ip=$(ip -4 -o addr show dev "$w" 2>/dev/null | awk '{print $4}' | cut -d'/' -f1 | head -n1)
            ssid=$(iw dev "$w" link 2>/dev/null | awk -F': ' '/SSID/{print $2; exit}')
            # Best-effort connectivity check
            conn=$(nmcli networking connectivity 2>/dev/null || echo "")
            echo "$w|wifi|$ip|$ssid|$conn"
            return 0
        fi
    done
    return 1
}

get_route() {
    # Fallback: use ip route to infer the device and source IP
    read -r dev src <<< $(ip route get 1.1.1.1 2>/dev/null | awk '{for(i=1;i<=NF;i++){if($i=="dev"){dev=$(i+1)}; if($i=="src"){src=$(i+1)}}} END{print dev,src}')
    if [ -n "$dev" ]; then
        # If iw knows about this dev, mark as wifi
        if command -v iw >/dev/null 2>&1 && iw dev 2>/dev/null | grep -qw "$dev"; then
            type=wifi
        else
            type=ethernet
        fi
        # connectivity fallback: ping once
        if ping -c1 -W1 1.1.1.1 >/dev/null 2>&1; then
            conn=full
        else
            conn=limited
        fi
        echo "$dev|$type|$src||$conn"
        return 0
    fi
    return 1
}

result=""
if command -v nmcli >/dev/null 2>&1; then
    result=$(get_nmcli) || true
fi
if [ -z "$result" ] && command -v iw >/dev/null 2>&1; then
    result=$(get_iw) || true
fi
if [ -z "$result" ]; then
    result=$(get_route) || true
fi

if [ -z "$result" ]; then
    # no connection; show icon only
    printf "%s" "$DISCONNECTED_ICON"
    exit 0
fi

IFS='|' read -r iface type ipaddr ssid conn <<< "$result"

# Determine icon
if [ "$type" = "wifi" ] || [[ "$iface" == wl* ]]; then
    icon="$WIFI_ICON"
else
    icon="$WIRED_ICON"
fi

# Determine connectivity indicator (use nmcli connectivity when available)
indicator=""
if [ -n "$conn" ] && [ "$conn" != "full" ]; then
    indicator=" $LIMITED_ICON"
fi

# Build output: for wifi show SSID (and IP if available), for wired show IP
if [ "$type" = "wifi" ]; then
    if [ -n "$ssid" ]; then
        if [ -n "$ipaddr" ]; then
            printf "%s %s %s%s" "$icon" "$ssid" "$ipaddr" "$indicator"
        else
            printf "%s %s%s" "$icon" "$ssid" "$indicator"
        fi
    else
        if [ -n "$ipaddr" ]; then
            printf "%s %s%s" "$icon" "$ipaddr" "$indicator"
        else
            printf "%s%s" "$icon" "$indicator"
        fi
    fi
else
    if [ -n "$ipaddr" ]; then
        printf "%s %s%s" "$icon" "$ipaddr" "$indicator"
    else
        printf "%s%s" "$icon" "$indicator"
    fi
fi

